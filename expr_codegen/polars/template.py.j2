# this code is auto generated by the expr_codegen
# https://github.com/wukan1986/expr_codegen
# 此段代码由 expr_codegen 自动生成，欢迎提交 issue 或 pull request

import re

import numpy as np
import polars as pl
import polars.selectors as cs

from loguru import logger

# from polars_ta.prefix.ta import *  # noqa
# from polars_ta.prefix.talib import *  # noqa
# from polars_ta.prefix.tdx import *  # noqa
from polars_ta.prefix.wq import *  # noqa

# TODO: 数据加载或外部传入
df = df_input


{% for key, value in funcs.items() %}
def {{ key }}(df: pl.DataFrame) -> pl.DataFrame:
{{ value }}
    return df
{% endfor %}

#logger.info("start...")

{% for key, value in groupbys.items() %}
{{ value-}}
{% endfor %}

{% for row in exprs_dst %}
{{ row-}}
{% endfor %}

"""
{{ syms_dst }}
"""

"""
{%-for key, value in exprs_src.items() %}
{{ key }} = {{ value-}}
{% endfor %}
"""

# drop intermediate columns
df = df.drop(columns=list(filter(lambda x: re.search(r"^_x_\d+", x), df.columns)))

# shrink
df = df.select(cs.all().shrink_dtype())
df = df.shrink_to_fit()

# logger.info('done')

# save
# df.write_parquet('output.parquet', compression='zstd')

# print(df.tail(5))

# 向外部传出数据
df_output = df
